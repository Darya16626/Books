{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Все чаты с клиентами</title>

<!-- Google Fonts с кириллицей -->
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative&family=Lobster&family=Orbitron&family=Pacifico&family=Russo+One&family=Vampiro+One&display=swap&subset=cyrillic" rel="stylesheet" />

<link rel="stylesheet" href="{% static 'css/style.css' %}" />
<style>
:root {
  --color-accent: #0066cc;
  --color-bg-light: #e6f0ff;
  --color-bg-dark: #1a162b;
  --color-text-light: #222222;
  --color-text-dark: #eaeaea;

  --font-family: 'Cinzel Decorative', serif;

  --border-radius: 10px;
  --btn-padding: 12px 25px;
  --btn-font-size: 1rem;
  --btn-shadow: 0 5px 15px rgba(0, 102, 204, 0.25);
  --card-shadow-light: 0 10px 40px rgba(0, 102, 255, 0.2);
  --card-shadow-dark: 0 10px 30px rgba(0,0,0,0.6);
}

body {
  margin: 30px 20px;
  font-family: var(--font-family);
  background: var(--color-bg-light);
  background: linear-gradient(135deg, #e6f0ff 0%, #cce0ff 50%, #a3cfff 100%);
  background-repeat: no-repeat;
  background-attachment: fixed;
  color: var(--color-text-light);
  transition: background-color 0.8s ease, color 0.4s ease;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
  overflow-x: hidden;
  overflow-y: auto;
}

body.dark-theme {
  background: var(--color-bg-dark);
  color: var(--color-text-dark);
  --btn-shadow: 0 5px 15px rgba(0,66,134,0.7);
  --card-shadow: var(--card-shadow-dark);
}

/* Canvas и SVG фон */
#star-canvas, #constellation-svg {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  pointer-events: none;
  user-select: none;
  z-index: 0;
}

/* Основной контейнер */
.main-wrapper {
  width: 100%;
  max-width: 600px;
  border-radius: var(--border-radius);
  padding: 10px;
  position: relative;
  margin-bottom: 30px;
  box-shadow: 0 0 30px 8px var(--color-accent);
  background: rgba(255 255 255 / 0.85);
  color: var(--color-text-light);
  transition: box-shadow 0.4s, border-radius 0.4s, background 0.4s, color 0.4s;
  z-index: 10;
}
body.dark-theme .main-wrapper {
  background: rgba(30 30 47 / 0.85);
  color: var(--color-text-dark);
}

main {
  background: transparent;
  border-radius: var(--border-radius);
  color: inherit;
  text-align: center;
}

/* Базовые кнопки */
button {
  font-family: var(--font-family);
  color: #fff;
  background-color: var(--color-accent);
  border: none;
  border-radius: var(--border-radius);
  padding: var(--btn-padding);
  font-size: var(--btn-font-size);
  box-shadow: var(--btn-shadow);
  cursor: pointer;
  transition: background-color 0.3s, box-shadow 0.3s;
  user-select: none;
}
button:hover {
  filter: brightness(110%);
}
#theme-toggle-btn {
  margin-left: 15px;
}

/* Кнопка назад */
a.back-button {
  margin: 20px 0;
  color: var(--color-accent);
  text-decoration: none;
  font-weight: 600;
  transition: color 0.3s;
  user-select: none;
  display: inline-block;
  font-family: var(--font-family);
}
a.back-button:hover {
  color: #004a99;
}

ul.chat-list {
  max-width: 720px;
  margin: 0 auto;
  padding: 0;
  list-style: none;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

ul.chat-list li {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.07);
  padding: 16px 20px;
  transition: box-shadow 0.3s ease, transform 0.2s ease;
}

ul.chat-list li:hover {
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
  transform: translateY(-3px);
}

ul.chat-list li a {
  text-decoration: none;
  color: var(--color-accent);
  font-weight: 600;
  font-size: 1.05rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
}

ul.chat-list li a:hover {
  color: #004a99;
  text-decoration: underline;
}

.chat-info {
  font-weight: 400;
  color: #555;
  font-size: 0.9rem;
  white-space: nowrap;
}

.chat-tag {
  background-color: #fce4e4;
  color: #d32f2f;
  font-size: 0.85rem;
  padding: 2px 8px;
  border-radius: 14px;
  font-weight: 600;
  white-space: nowrap;
}

/* Адаптив */
@media (max-width: 480px) {
  ul.chat-list li a {
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
    font-size: 1rem;
  }

  .chat-info {
    white-space: normal;
    color: #666;
  }
}
</style>
</head>

<body>
<header style="width:100%;max-width:600px;display:flex;justify-content:space-between;align-items:center;margin:20px auto;">
  <a href="{% url 'manager_page' %}" class="back-button" aria-label="Назад к админ панели">← Назад</a>
  <button id="theme-toggle-btn" type="button" aria-pressed="false" aria-label="Переключить светлую и тёмную тему">Тёмная / Светлая тема</button>
</header>

<canvas id="star-canvas"></canvas>
<svg id="constellation-svg" aria-hidden="true" focusable="false"></svg>

<div class="main-wrapper" role="main" aria-label="Все чаты с клиентами">
  <main>
    <h2>Все чаты с клиентами</h2>

    <ul class="chat-list" aria-label="Список всех чатов с клиентами">
      {% for chat in chats %}
        <li>
          <a href="{% url 'manager_chat_detail' chat.id %}">
            <span>{{ chat.client.get_full_name }} ({{ chat.client.profile.role }})</span>
            <span class="chat-info">начало: {{ chat.created_at|date:"d.m.Y H:i" }}</span>
            {% if chat.is_manager_deleted %}
              <span class="chat-tag">Менеджер удалён</span>
            {% endif %}
          </a>
        </li>
      {% empty %}
        <li style="text-align:center; color:#888; font-style: italic;">Нет активных чатов</li>
      {% endfor %}
    </ul>
  </main>
</div>

<script>
// Canvas и анимация фона (звёзды, кометы, созвездия)
const canvas = document.getElementById('star-canvas');
const ctx = canvas.getContext('2d');
const constellationSVG = document.getElementById('constellation-svg');
let width, height;

function resize() {
  width = window.innerWidth;
  height = window.innerHeight;
  canvas.width = width * devicePixelRatio;
  canvas.height = height * devicePixelRatio;
  canvas.style.width = width + 'px';
  canvas.style.height = height + 'px';
  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.scale(devicePixelRatio, devicePixelRatio);
}
resize();
window.addEventListener('resize', () => {
  resize();
  createConstellation();
  stars.forEach(star => star.reset());
  comets.forEach(comet => comet.reset());
});

class Star {
  constructor() {
    this.reset();
  }
  reset() {
    this.x = Math.random() * width;
    this.y = Math.random() * height;
    this.radius = (Math.random() * 1.2 + 0.4) * (isDarkTheme() ? 1 : 1.6);
    this.alpha = Math.random() * 0.8 + 0.4;
    this.dAlpha = (Math.random() * 0.007 + 0.002) * (Math.random() < 0.5 ? 1 : -1);
    this.speedX = (Math.random() - 0.5) * 0.06;
    this.speedY = (Math.random() - 0.5) * 0.06;
  }
  update() {
    this.alpha += this.dAlpha;
    if (this.alpha <= (isDarkTheme() ? 0.3 : 0.5) || this.alpha >= 1)
      this.dAlpha = -this.dAlpha;
    this.x += this.speedX;
    this.y += this.speedY;
    if (this.x < 0) this.x = width;
    if (this.x > width) this.x = 0;
    if (this.y < 0) this.y = height;
    if (this.y > height) this.y = 0;
  }
  draw() {
    ctx.beginPath();
    ctx.fillStyle = isDarkTheme()
      ? `rgba(255, 255, 255, ${this.alpha})`
      : `rgba(30, 115, 255, ${this.alpha * 0.9})`;
    ctx.shadowColor = isDarkTheme()
      ? 'rgba(255,255,255,0.7)'
      : 'rgba(100,170,255,0.8)';
    ctx.shadowBlur = isDarkTheme() ? 4 : 10;
    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
    ctx.fill();
    ctx.shadowBlur = 0;
  }
}

class Comet {
  constructor() {
    this.reset();
  }
  reset() {
    this.x = Math.random() * width;
    this.y = Math.random() * height * 0.5;
    this.length = 80 + Math.random() * 40;
    this.speedX = 4 + Math.random() * 3;
    this.speedY = -0.5 + Math.random();
    this.radius = (1.5 + Math.random()) * (isDarkTheme() ? 1 : 1.4);
    this.tailLength = this.length * 1.5;
    this.tailWidth = this.radius * 4;
    this.alpha = 0.85 + Math.random() * 0.15;
  }
  update() {
    this.x += this.speedX;
    this.y += this.speedY;
    if (
      this.x - this.tailLength > width ||
      this.y + this.tailLength < 0 ||
      this.y - this.tailLength > height
    ) {
      this.reset();
      this.x = -this.tailLength;
    }
  }
  draw() {
    const gradient = ctx.createLinearGradient(
      this.x,
      this.y,
      this.x - this.tailLength,
      this.y - this.tailLength * 0.5
    );
    gradient.addColorStop(
      0,
      isDarkTheme()
        ? `rgba(255,255,255,${this.alpha})`
        : `rgba(100,170,255,${this.alpha * 0.9})`
    );
    gradient.addColorStop(1, 'rgba(255,255,255,0)');
    ctx.beginPath();
    ctx.fillStyle = gradient;
    ctx.shadowColor = isDarkTheme()
      ? 'rgba(255,255,255,0.9)'
      : 'rgba(100,170,255,0.7)';
    ctx.shadowBlur = isDarkTheme() ? 10 : 15;
    ctx.moveTo(this.x, this.y);
    ctx.lineTo(this.x - this.tailLength, this.y - this.tailLength * 0.5);
    ctx.lineTo(
      this.x - this.tailLength + this.tailWidth,
      this.y - this.tailLength * 0.5 + this.tailWidth * 0.5
    );
    ctx.closePath();
    ctx.fill();
    ctx.shadowBlur = 0;

    ctx.beginPath();
    ctx.fillStyle = isDarkTheme()
      ? `rgba(255,255,255,${this.alpha})`
      : `rgba(100,170,255,${this.alpha})`;
    ctx.shadowColor = isDarkTheme()
      ? 'rgba(255,255,255,1)'
      : 'rgba(100,170,255,1)';
    ctx.shadowBlur = isDarkTheme() ? 15 : 20;
    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
    ctx.fill();
    ctx.shadowBlur = 0;
  }
}

const stars = [];
const TOTAL_STARS = 180;
for (let i = 0; i < TOTAL_STARS; i++) stars.push(new Star());

const comets = [];
const TOTAL_COMETS = 3;
for (let i = 0; i < TOTAL_COMETS; i++) comets.push(new Comet());

const constellationPoints = [
  { x: 0.2 * width, y: 0.2 * height },
  { x: 0.4 * width, y: 0.25 * height },
  { x: 0.6 * width, y: 0.15 * height },
  { x: 0.75 * width, y: 0.35 * height },
  { x: 0.85 * width, y: 0.2 * height },

  { x: 0.3 * width, y: 0.7 * height },
  { x: 0.5 * width, y: 0.8 * height },
  { x: 0.7 * width, y: 0.75 * height },
  { x: 0.9 * width, y: 0.85 * height },
];

const constellationLines = [
  [0, 1],
  [1, 2],
  [2, 4],
  [0, 3],
  [3, 4],
  [5, 6],
  [6, 7],
  [7, 8],
];

function createConstellation() {
  constellationSVG.innerHTML = '';
  constellationPoints.forEach((point, i) => {
    const circle = document.createElementNS(
      'http://www.w3.org/2000/svg',
      'circle'
    );
    circle.setAttribute('cx', point.x);
    circle.setAttribute('cy', point.y);
    circle.setAttribute('r', isDarkTheme() ? 4 : 6);
    circle.setAttribute('fill', isDarkTheme() ? 'lightpink' : '#4aa1ff');
    circle.style.filter = isDarkTheme()
      ? 'drop-shadow(0 0 4px #ffa6ba)'
      : 'drop-shadow(0 0 6px #5fb0ff)';
    circle.classList.add('const-star');
    constellationSVG.appendChild(circle);
  });
  constellationLines.forEach((line) => {
    const [startIdx, endIdx] = line;
    const start = constellationPoints[startIdx];
    const end = constellationPoints[endIdx];
    const polyline = document.createElementNS(
      'http://www.w3.org/2000/svg',
      'polyline'
    );
    polyline.setAttribute(
      'points',
      `${start.x},${start.y} ${end.x},${end.y}`
    );
    polyline.setAttribute('stroke', isDarkTheme() ? 'lightpink' : '#4aa1ff');
    polyline.setAttribute('stroke-width', isDarkTheme() ? 2 : 3);
    polyline.setAttribute('fill', 'none');
    polyline.style.filter = isDarkTheme()
      ? 'drop-shadow(0 0 4px #ffa6ba)'
      : 'drop-shadow(0 0 6px #5fb0ff)';
    constellationSVG.appendChild(polyline);
  });
}
createConstellation();

let constellationOffset = { x: 0, y: 0 };
let direction = 1;

function animate() {
  ctx.clearRect(0, 0, width, height);
  stars.forEach((star) => {
    star.update();
    star.draw();
  });
  comets.forEach((comet) => {
    comet.update();
    comet.draw();
  });
  constellationOffset.x += 0.02 * direction;
  if (Math.abs(constellationOffset.x) > 10) direction *= -1;
  constellationSVG.style.transform = `translate(${constellationOffset.x}px, ${
    Math.sin(constellationOffset.x * 0.3) * 5
  }px)`;
  constellationSVG.querySelectorAll('circle').forEach((circle, i) => {
    let baseAlpha = 0.7 + 0.3 * Math.sin(Date.now() / 1000 + i);
    circle.style.opacity = baseAlpha.toFixed(2);
  });
  constellationSVG.querySelectorAll('polyline').forEach((pline, i) => {
    let baseAlpha = 0.5 + 0.4 * Math.sin(Date.now() / 1500 + i);
    pline.style.opacity = baseAlpha.toFixed(2);
  });
  requestAnimationFrame(animate);
}
requestAnimationFrame(animate);

function isDarkTheme() {
  return document.body.classList.contains('dark-theme');
}

function applyThemeAndPreferences() {
  const theme = localStorage.getItem('theme') || 'light';
  const accentColor = localStorage.getItem('accentColor') || '#0066cc';
  const borderRadius = localStorage.getItem('borderRadius') || '10px';
  const fontFamily = localStorage.getItem('fontFamily') || "'Cinzel Decorative', serif";

  if (theme === 'dark') {
    document.body.classList.add('dark-theme');
  } else {
    document.body.classList.remove('dark-theme');
  }

  document.documentElement.style.setProperty('--color-accent', accentColor);
  document.documentElement.style.setProperty('--border-radius', borderRadius);
  document.documentElement.style.setProperty('--font-family', fontFamily);

  const mainWrapper = document.querySelector('.main-wrapper');
  if (mainWrapper) {
    mainWrapper.style.borderRadius = borderRadius;
    mainWrapper.style.boxShadow = `0 0 30px 8px ${accentColor}`;
  }

  stars.forEach((star) => star.reset());
  comets.forEach((comet) => comet.reset());
  createConstellation();
}

function toggleTheme() {
  const currentTheme = document.body.classList.contains('dark-theme')
    ? 'dark'
    : 'light';
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  localStorage.setItem('theme', newTheme);
  applyThemeAndPreferences();
}

window.addEventListener('DOMContentLoaded', () => {
  applyThemeAndPreferences();
  const toggleBtn = document.getElementById('theme-toggle-btn');
  toggleBtn.addEventListener('click', toggleTheme);
});
</script>
</body>
</html>
