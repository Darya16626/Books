{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Чат с клиентом</title>

<!-- Шрифты Google с поддержкой кириллицы -->
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative&family=Lobster&family=Orbitron&family=Pacifico&family=Russo+One&family=Vampiro+One&display=swap&subset=cyrillic" rel="stylesheet" />

<style>
:root {
  --color-accent: #0066cc;
  --color-bg-light: linear-gradient(135deg, #e6f0ff 0%, #cce0ff 50%, #a3cfff 100%);
  --color-bg-dark: #1a162b;
  --color-text-light: #222222;
  --color-text-dark: #eaeaea;
  --font-family: 'Cinzel Decorative', serif;
  --border-radius: 10px;
  --btn-padding: 12px 25px;
  --btn-font-size: 1rem;
  --btn-shadow-light: 0 5px 15px rgba(0,102,255,0.4);
  --btn-shadow-dark: 0 5px 15px rgba(0,66,134,0.7);
  --card-shadow-light: 0 10px 40px rgba(0, 102, 255, 0.2);
  --card-shadow-dark: 0 10px 30px rgba(0,0,0,0.6);
}

body {
  margin: 30px 20px;
  font-family: var(--font-family);
  color: var(--color-text-light);
  background: var(--color-bg-light);
  background-repeat: no-repeat;
  background-attachment: fixed;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
  overflow-x: hidden;
  overflow-y: auto;
  transition: background-color 0.8s ease, color 0.4s ease;
}

body.dark-theme {
  background: var(--color-bg-dark);
  color: var(--color-text-dark);
}

#star-canvas, #constellation-svg {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  pointer-events: none;
  user-select: none;
  z-index: 0;
}

.main-wrapper {
  width: 100%;
  max-width: 720px;
  border-radius: var(--border-radius);
  padding: 20px;
  background: rgba(255 255 255 / 0.85);
  box-shadow: 0 0 30px 8px var(--color-accent);
  z-index: 10;
  transition: background 0.4s, box-shadow 0.4s;
}
body.dark-theme .main-wrapper {
  background: rgba(30 30 47 / 0.85);
  box-shadow: 0 0 30px 8px var(--color-accent);
}

/* Чат */
#chat-box {
  max-width: 720px;
  margin: 0 auto 25px;
  background: transparent;
  border-radius: var(--border-radius);
  padding: 20px;
  height: 420px;
  overflow-y: auto;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  gap: 14px;
  color: inherit;
  font-family: var(--font-family);
  font-size: 1rem;
  box-shadow: var(--card-shadow-light);
}
body.dark-theme #chat-box {
  box-shadow: var(--card-shadow-dark);
}

/* Сообщения */
.message {
  max-width: 65%;
  padding: 12px 18px;
  border-radius: 20px;
  line-height: 1.4;
  word-wrap: break-word;
  position: relative;
  font-size: 1rem;
}
.sender-you {
  background-color: #d1e7dd;
  margin-left: auto;
  color: #155724;
  text-align: right;
}
body.dark-theme .sender-you {
  background-color: #27472d;
  color: #a7d9ad;
}
.sender-you strong {
  display: block;
  margin-bottom: 6px;
  font-weight: 700;
  color: inherit;
}

.sender-other {
  background-color: #dbe9fb;
  margin-right: auto;
  color: #0d47a1;
  text-align: left;
}
body.dark-theme .sender-other {
  background-color: #2c3678;
  color: #aacaff;
}
.sender-other strong {
  display: block;
  margin-bottom: 6px;
  font-weight: 700;
  color: inherit;
}

.message small.timestamp {
  display: block;
  margin-top: 8px;
  font-size: 0.75rem;
  color: #6c757d;
}
body.dark-theme .message small.timestamp {
  color: #b0b8c3;
}

/* Кнопки удаления и редактирования */
.delete-btn, .edit-btn {
  background: transparent;
  border: none;
  cursor: pointer;
  font-size: 0.85rem;
  margin-top: 6px;
  transition: color 0.3s ease;
  font-family: var(--font-family);
}
.delete-btn {
  color: #dc3545;
}
.delete-btn:hover {
  color: #b02a37;
  text-decoration: underline;
}
.edit-btn {
  color: #0d6efd;
  margin-left: 8px;
}
.edit-btn:hover {
  color: #084abb;
  text-decoration: underline;
}

/* Форма отправки */
form.message-form {
  max-width: 720px;
  margin: 0 auto 30px;
  display: flex;
  gap: 10px;
  font-family: var(--font-family);
}
form.message-form textarea {
  flex: 1;
  resize: vertical;
  min-height: 80px;
  padding: 12px 15px;
  font-size: 1rem;
  border: 1.5px solid #ced4da;
  border-radius: var(--border-radius);
  font-family: var(--font-family);
  transition: border-color 0.3s ease;
}
form.message-form textarea:focus {
  border-color: var(--color-accent);
  outline: none;
}
form.message-form button {
  background-color: var(--color-accent);
  color: white;
  border: none;
  padding: var(--btn-padding);
  font-size: var(--btn-font-size);
  border-radius: var(--border-radius);
  cursor: pointer;
  font-weight: 700;
  box-shadow: var(--btn-shadow-light);
  transition: background-color 0.3s ease, box-shadow 0.3s ease;
}
form.message-form button:hover {
  background-color: #004a99;
  box-shadow: 0 5px 15px rgba(0,66,134,0.7);
}
body.dark-theme form.message-form button {
  box-shadow: var(--btn-shadow-dark);
}

/* Форма редактирования */
form.edit-form {
  margin-top: 8px;
}
form.edit-form textarea {
  width: 100%;
  min-height: 60px;
  padding: 8px;
  border-radius: 10px;
  border: 1px solid #bbb;
  font-family: inherit;
  font-size: 1rem;
}
form.edit-form button {
  margin-top: 4px;
  padding: 4px 12px;
  font-size: 0.9rem;
  border-radius: 10px;
  cursor: pointer;
}
form.edit-form button[type="submit"] {
  background-color: var(--color-accent);
  color: white;
  border: none;
  font-weight: 700;
  box-shadow: var(--btn-shadow-light);
  transition: background-color 0.3s ease, box-shadow 0.3s ease;
}
form.edit-form button[type="submit"]:hover {
  background-color: #004a99;
  box-shadow: 0 5px 15px rgba(0,66,134,0.7);
}
body.dark-theme form.edit-form button[type="submit"] {
  box-shadow: var(--btn-shadow-dark);
}
form.edit-form button[type="button"] {
  background-color: #ddd;
  border: none;
  color: #333;
}
form.edit-form button[type="button"]:hover {
  background-color: #bbb;
}

/* Ссылка назад */
a.back-link {
  color: var(--color-accent);
  font-weight: 600;
  text-decoration: none;
  transition: color 0.3s ease;
  font-family: var(--font-family);
  max-width: 720px;
  display: block;
  margin: 0 auto;
}
a.back-link:hover {
  color: #004a99;
  text-decoration: underline;
}

/* Кнопка назад вверху */
.button-back {
  padding: 8px 16px;
  background-color: var(--color-accent);
  border: none;
  border-radius: 8px;
  color: white;
  cursor: pointer;
  font-weight: 600;
  font-family: var(--font-family);
  max-width: 720px;
  margin: 20px auto 10px;
  display: block;
}

/* Тёмная тема изменения для кнопки назад */
body.dark-theme .button-back {
  background-color: #004a99;
}

/* Notification */
p.notification {
  max-width: 720px;
  margin: 10px auto 20px;
  color: #e74c3c;
  font-weight: 700;
  text-align: center;
  font-family: var(--font-family);
}

/* Disabled message */
p.disabled-message {
  max-width: 720px;
  margin: 0 auto 30px;
  text-align: center;
  color: #6c757d;
  font-style: italic;
  font-family: var(--font-family);
}

/* Dark theme modifications */
body.dark-theme {
  --color-accent: #3399ff;
}
body.dark-theme #chat-box {
  box-shadow: var(--card-shadow-dark);
}
</style>
</head>
<body>

<header style="width: 100%; max-width: 720px; margin: 0 auto 20px; display: flex; justify-content: flex-end; align-items: center;">
  <button id="theme-toggle-btn" type="button" aria-pressed="false" aria-label="Переключить светлую и тёмную тему" style="font-family: var(--font-family); padding: var(--btn-padding); font-size: var(--btn-font-size); border-radius: var(--border-radius); border:none; cursor:pointer; box-shadow:var(--btn-shadow-light); background-color: var(--color-accent); color: #fff; transition: background-color 0.3s, box-shadow 0.3s;">
    Тёмная / Светлая тема
  </button>
</header>

<canvas id="star-canvas"></canvas>
<svg id="constellation-svg" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"></svg>

<div class="main-wrapper" role="main" aria-label="Чат с клиентом">
  <h2>Чат с клиентом {{ chat_partner_name }}</h2>

  {% if notification %}
  <p class="notification">{{ notification }}</p>
  {% endif %}

  <button type="button" class="button-back" onclick="history.back();">← Назад</button>

  <div id="chat-box" role="log" aria-live="polite" aria-relevant="additions">
    {% for message in messages %}
    <div class="message {% if message.sender == user %}sender-you{% else %}sender-other{% endif %}" data-message-id="{{ message.id }}">
      <strong>{{ message.sender.get_full_name }} ({{ message.sender.profile.role }}):</strong>
      <div class="message-text" id="message-text-{{ message.id }}">{{ message.text|linebreaks }}</div>
      <small class="timestamp">{{ message.created_at }}{% if message.updated_at and message.updated_at > message.created_at %} (ред.){% endif %}</small>
      
      {% if message.sender == user and not message.is_deleted %}
      <form method="post" action="{% url 'delete_message' message.id %}">
        {% csrf_token %}
        <button type="submit" class="delete-btn" onclick="return confirm('Удалить это сообщение?');" aria-label="Удалить сообщение">Удалить</button>
      </form>
      <button class="edit-btn" onclick="showEditForm({{ message.id }});" aria-label="Редактировать сообщение">Редактировать</button>
      <form method="post" action="{% url 'edit_message' message.id %}" class="edit-form" id="edit-form-{{ message.id }}" style="display:none;">
        {% csrf_token %}
        <textarea name="text" rows="3" required>{{ message.text }}</textarea>
        <button type="submit">Сохранить</button>
        <button type="button" onclick="hideEditForm({{ message.id }});">Отмена</button>
      </form>
      {% endif %}
    </div>
    {% empty %}
    <p style="text-align:center; color:#666;">Пока сообщений нет.</p>
    {% endfor %}
  </div>

  {% if can_send %}
  <form method="post" class="message-form" aria-label="Форма отправки сообщения">
    {% csrf_token %}
    <textarea name="message" rows="3" required placeholder="Напишите сообщение..."></textarea>
    <button type="submit">Отправить</button>
  </form>
  {% else %}
  <p class="disabled-message">Отправка сообщений прекращена.</p>
  {% endif %}

  <a href="{% url 'manager_support_page' %}" class="back-link">← Вернуться к списку чатов</a>
</div>

<script>
// Космический фон с звездами и кометами
const canvas = document.getElementById('star-canvas');
const ctx = canvas.getContext('2d');
const constellationSVG = document.getElementById('constellation-svg');
let width, height;

function resize() {
  width = window.innerWidth;
  height = window.innerHeight;
  canvas.width = width * devicePixelRatio;
  canvas.height = height * devicePixelRatio;
  canvas.style.width = width + 'px';
  canvas.style.height = height + 'px';
  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.scale(devicePixelRatio, devicePixelRatio);
}
resize();
window.addEventListener('resize', () => { resize(); createConstellation(); });

class Star {
  constructor() {
    this.reset();
  }
  reset() {
    this.x = Math.random() * width;
    this.y = Math.random() * height;
    this.radius = (Math.random() * 1.2 + 0.4) * (isDarkTheme() ? 1 : 1.6);
    this.alpha = Math.random() * 0.8 + 0.4;
    this.dAlpha = (Math.random() * 0.007 + 0.002) * (Math.random() < 0.5 ? 1 : -1);
    this.speedX = (Math.random() - 0.5) * 0.06;
    this.speedY = (Math.random() - 0.5) * 0.06;
  }
  update() {
    this.alpha += this.dAlpha;
    if (this.alpha <= (isDarkTheme() ? 0.3 : 0.5) || this.alpha >= 1) this.dAlpha = -this.dAlpha;
    this.x += this.speedX;
    this.y += this.speedY;
    if (this.x < 0) this.x = width;
    if (this.x > width) this.x = 0;
    if (this.y < 0) this.y = height;
    if (this.y > height) this.y = 0;
  }
  draw() {
    ctx.beginPath();
    ctx.fillStyle = isDarkTheme()
      ? `rgba(255, 255, 255, ${this.alpha})`
      : `rgba(30, 115, 255, ${this.alpha * 0.9})`;
    ctx.shadowColor = isDarkTheme() ? 'rgba(255,255,255,0.7)' : 'rgba(100,170,255,0.8)';
    ctx.shadowBlur = isDarkTheme() ? 4 : 10;
    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
    ctx.fill();
    ctx.shadowBlur = 0;
  }
}

class Comet {
  constructor() {
    this.reset();
  }
  reset() {
    this.x = Math.random() * width;
    this.y = Math.random() * height * 0.5;
    this.length = 80 + Math.random() * 40;
    this.speedX = 4 + Math.random() * 3;
    this.speedY = -0.5 + Math.random() * 1;
    this.radius = (1.5 + Math.random()) * (isDarkTheme() ? 1 : 1.4);
    this.tailLength = this.length * 1.5;
    this.tailWidth = this.radius * 4;
    this.alpha = 0.85 + Math.random() * 0.15;
  }
  update() {
    this.x += this.speedX;
    this.y += this.speedY;
    if (this.x - this.tailLength > width || this.y + this.tailLength < 0 || this.y - this.tailLength > height) {
      this.reset();
      this.x = -this.tailLength;
    }
  }
  draw() {
    const gradient = ctx.createLinearGradient(this.x, this.y, this.x - this.tailLength, this.y - this.tailLength*0.5);
    gradient.addColorStop(0, isDarkTheme() ? `rgba(255,255,255,${this.alpha})` : `rgba(100,170,255,${this.alpha * 0.9})`);
    gradient.addColorStop(1, 'rgba(255,255,255,0)');
    ctx.beginPath();
    ctx.fillStyle = gradient;
    ctx.shadowColor = isDarkTheme() ? 'rgba(255,255,255,0.9)' : 'rgba(100,170,255,0.7)';
    ctx.shadowBlur = isDarkTheme() ? 10 : 15;
    ctx.moveTo(this.x, this.y);
    ctx.lineTo(this.x - this.tailLength, this.y - this.tailLength*0.5);
    ctx.lineTo(this.x - this.tailLength + this.tailWidth, this.y - this.tailLength*0.5 + this.tailWidth*0.5);
    ctx.closePath();
    ctx.fill();
    ctx.shadowBlur = 0;

    ctx.beginPath();
    ctx.fillStyle = isDarkTheme() ? `rgba(255,255,255,${this.alpha})` : `rgba(100,170,255,${this.alpha})`;
    ctx.shadowColor = isDarkTheme() ? 'rgba(255,255,255,1)' : 'rgba(100,170,255,1)';
    ctx.shadowBlur = isDarkTheme() ? 15 : 20;
    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
    ctx.fill();
    ctx.shadowBlur = 0;
  }
}

function isDarkTheme() {
  return document.body.classList.contains('dark-theme');
}

const stars = [];
const TOTAL_STARS = 180;
for(let i = 0; i < TOTAL_STARS; i++) stars.push(new Star());

const comets = [];
const TOTAL_COMETS = 3;
for(let i = 0; i < TOTAL_COMETS; i++) comets.push(new Comet());

const constellationPoints = [
  {x: 0.2 * width, y: 0.2 * height},
  {x: 0.4 * width, y: 0.25 * height},
  {x: 0.6 * width, y: 0.15 * height},
  {x: 0.75 * width, y: 0.35 * height},
  {x: 0.85 * width, y: 0.2 * height},

  {x: 0.3 * width, y: 0.7 * height},
  {x: 0.5 * width, y: 0.8 * height},
  {x: 0.7 * width, y: 0.75 * height},
  {x: 0.9 * width, y: 0.85 * height},
];
const constellationLines = [
  [0, 1], [1, 2], [2, 4],
  [0, 3], [3, 4],
  [5, 6], [6, 7], [7, 8]
];

function createConstellation() {
  constellationSVG.innerHTML = '';
  constellationPoints.forEach((point, i) => {
    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    circle.setAttribute('cx', point.x);
    circle.setAttribute('cy', point.y);
    circle.setAttribute('r', isDarkTheme() ? 4 : 6);
    circle.setAttribute('fill', isDarkTheme() ? 'lightpink' : '#4aa1ff');
    circle.style.filter = isDarkTheme() ? 'drop-shadow(0 0 4px #ffa6ba)' : 'drop-shadow(0 0 6px #5fb0ff)';
    circle.classList.add('const-star');
    constellationSVG.appendChild(circle);
  });

  constellationLines.forEach(line => {
    const [startIdx, endIdx] = line;
    const start = constellationPoints[startIdx];
    const end = constellationPoints[endIdx];
    const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
    polyline.setAttribute('points', `${start.x},${start.y} ${end.x},${end.y}`);
    polyline.setAttribute('stroke', isDarkTheme() ? 'lightpink' : '#4aa1ff');
    polyline.setAttribute('stroke-width', isDarkTheme() ? 2 : 3);
    polyline.setAttribute('fill', 'none');
    polyline.style.filter = isDarkTheme() ? 'drop-shadow(0 0 4px #ffa6ba)' : 'drop-shadow(0 0 6px #5fb0ff)';
    constellationSVG.appendChild(polyline);
  });
}
createConstellation();

let constellationOffset = {x: 0, y: 0};
let direction = 1;

function animate() {
  ctx.clearRect(0, 0, width, height);

  stars.forEach(star => {
    star.update();
    star.draw();
  });

  comets.forEach(comet => {
    comet.update();
    comet.draw();
  });

  constellationOffset.x += 0.02 * direction;
  if (Math.abs(constellationOffset.x) > 10) direction *= -1;

  constellationSVG.style.transform = `translate(${constellationOffset.x}px, ${Math.sin(constellationOffset.x * 0.3) * 5}px)`;

  constellationSVG.querySelectorAll('circle').forEach((circle, i) => {
    let baseAlpha = 0.7 + 0.3 * Math.sin(Date.now() / 1000 + i);
    circle.style.opacity = baseAlpha.toFixed(2);
  });
  constellationSVG.querySelectorAll('polyline').forEach((pline, i) => {
    let baseAlpha = 0.5 + 0.4 * Math.sin(Date.now() / 1500 + i);
    pline.style.opacity = baseAlpha.toFixed(2);
  });

  requestAnimationFrame(animate);
}
requestAnimationFrame(animate);


// Переключение темы и сохранение в localStorage
function applyThemeAndPreferences() {
  const theme = localStorage.getItem('theme') || 'light';
  const accentColor = localStorage.getItem('accentColor') || '#0066cc';
  const borderRadius = localStorage.getItem('borderRadius') || '10px';
  const fontFamily = localStorage.getItem('fontFamily') || "'Cinzel Decorative', serif";

  if(theme === 'dark') {
    document.body.classList.add('dark-theme');
  } else {
    document.body.classList.remove('dark-theme');
  }

  document.documentElement.style.setProperty('--color-accent', accentColor);
  document.documentElement.style.setProperty('--border-radius', borderRadius);
  document.documentElement.style.setProperty('--font-family', fontFamily);

  const mainWrapper = document.querySelector('.main-wrapper');
  if(mainWrapper) {
    mainWrapper.style.borderRadius = borderRadius;
    mainWrapper.style.boxShadow = `0 0 30px 8px ${accentColor}`;
  }

  // Кнопка переключения темы стилизована динамически
  const themeBtn = document.getElementById('theme-toggle-btn');
  if(themeBtn) {
    themeBtn.style.backgroundColor = accentColor;
    themeBtn.style.boxShadow = isDarkTheme() ? '0 5px 15px rgba(0,66,134,0.7)' : '0 5px 15px rgba(0,102,255,0.4)';
  }

  // Обновить параметры звезд и комет для текущей темы
  stars.forEach(star => star.reset());
  comets.forEach(comet => comet.reset());

  createConstellation();
}

function toggleTheme() {
  const currentTheme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  localStorage.setItem('theme', newTheme);
  applyThemeAndPreferences();
}

window.addEventListener('DOMContentLoaded', () => {
  applyThemeAndPreferences();
  document.getElementById('theme-toggle-btn').addEventListener('click', toggleTheme);
});

// Функции для редактирования сообщений
function showEditForm(messageId) {
  document.getElementById('message-text-' + messageId).style.display = 'none';
  document.getElementById('edit-form-' + messageId).style.display = 'block';
}
function hideEditForm(messageId) {
  document.getElementById('edit-form-' + messageId).style.display = 'none';
  document.getElementById('message-text-' + messageId).style.display = 'block';
}

// Автопрокрутка чата вниз
const chatBox = document.getElementById('chat-box');
chatBox.scrollTop = chatBox.scrollHeight;

// AJAX отметка сообщений как прочитанных (пример, требует серверной поддержки)
document.addEventListener('DOMContentLoaded', () => {
  let unreadMessages = Array.from(document.querySelectorAll('.message')).filter(m => !m.classList.contains('sender-you'));
  let messageIds = unreadMessages.map(m => m.dataset.messageId);

  if(messageIds.length > 0){
    fetch("{% url 'mark_as_read' %}", {
      method: 'POST',
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: new URLSearchParams({'message_ids[]': messageIds})
    })
    .then(response => response.json())
    .then(data => {
      console.log('Messages marked as read:', data.updated);
    });
  }
});
</script>

</body>
</html>
